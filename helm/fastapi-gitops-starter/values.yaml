# Default values for fastapi-gitops-starter. # pragma: allowlist secret
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

replicaCount: 1

image:
  repository: ghcr.io/lawranceb/fastapi-gitops-starter
  pullPolicy: IfNotPresent
  tag: "3.0.0"

registry:
  createImagePullSecret: false
  # secretName: image-pull-secret # pragma: allowlist secret
  # server: ghcr.io
  # token: "<set-ghcr-token>" # pragma: allowlist secret

# imagePullSecrets:
#   - name: image-pull-secret

nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Automatically mount a ServiceAccount's API credentials?
  automount: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

podAnnotations: {}
podLabels: {}

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: false

service:
  type: ClusterIP
  port: 80
  targetPort: 8000
  annotations: {}

ingress:
  enabled: true
  className: "nginx"
  annotations: {}
    # cert-manager.io/cluster-issuer: letsencrypt-prod
  hosts:
    - host: naavre-dev.minikube.test
      paths:
        - path: /
          pathType: Prefix
  tls: []
  #  - secretName: fastapi-gitops-starter-tls
  #    hosts:
  #      - fastapi-gitops-starter.local

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

livenessProbe:
  httpGet:
    path: /GitOps-Starter/health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /GitOps-Starter/health
    port: http
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

# Additional volumes on the output Deployment definition.
volumes: []
# - name: foo
#   secret:
#     secretName: mysecret
#     optional: false

# Additional volumeMounts on the output Deployment definition.
volumeMounts: []
# - name: foo
#   mountPath: "/etc/foo"
#   readOnly: true

nodeSelector: {}

tolerations: []

affinity: {}

# Application configuration
app:
  rootPath: "/GitOps-Starter"

# Argo Rollouts configuration
rollout:
  # Enable Argo Rollouts (requires argo-rollouts to be installed in the cluster)
  enabled: false
  # Strategy type: canary or blueGreen
  strategy: canary
  # Canary strategy configuration
  canary:
    # Number of steps in the canary deployment
    steps:
      - setWeight: 20
      - pause: {duration: 30s}
      - setWeight: 40
      - pause: {duration: 30s}
      - setWeight: 60
      - pause: {duration: 30s}
      - setWeight: 80
      - pause: {duration: 30s}
    # Max surge and unavailable during rollout
    maxSurge: "25%"
    maxUnavailable: 0
  # Blue-Green strategy configuration
  blueGreen:
    # Service names for blue-green deployment
    activeService: ""  # Will default to the main service name if empty
    previewService: ""  # Will default to chart fullname with "-preview" suffix if empty
    # Auto promotion configuration
    autoPromotionEnabled: true
    autoPromotionSeconds: 30
    # Scale down delay after promotion
    scaleDownDelaySeconds: 30
  # Analysis configuration for automated rollout decisions based on metrics
  analysis:
    # Enable analysis during rollouts
    enabled: false
    # Traffic generator configuration (generates HTTP traffic during analysis)
    trafficGenerator:
      # Enable traffic generation job
      enabled: false
      # Container image for traffic generation (default: curlimages/curl:latest)
      image: "curlimages/curl:latest"
      # Initial delay before starting traffic generation
      initialDelay: "5s"
      # How often to run the traffic generation job
      interval: "10s"
      # Number of times to run the traffic generation job
      count: 1
      # Duration of traffic generation in seconds
      duration: 60
      # Number of requests per second to generate
      requestsPerSecond: 10
      # Service URL (defaults to the internal cluster service)
      serviceUrl: ""
      # Backoff limit for the job
      backoffLimit: 1
      # Custom script for traffic generation (optional, overrides default)
      script: ""
    # Prometheus configuration (required when analysis is enabled)
    prometheus:
      address: ""  # Prometheus server address, e.g., "http://monitoring-kube-prometheus-prometheus.monitoring.svc.cluster.local:9090"
    # Metric definitions for analysis
    metrics:
      # Success rate metric (measures percentage of non-5xx responses)
      successRate:
        enabled: false
        interval: "1m"  # How often to check the metric
        count: 5  # Number of measurements to perform
        successCondition: "result >= 0.95"  # 95% success rate threshold
        failureLimit: 3  # Number of failed measurements before marking as failed
        timeRange: "5m"  # Prometheus query time range
        initialDelay: "30s"  # Wait time before starting measurements
        query: ""  # Custom Prometheus query (optional, overrides default)
      # Response time metric (measures 95th percentile response time)
      responseTime:
        enabled: false
        interval: "1m"
        count: 5
        successCondition: "result <= 1.0"  # Max 1 second response time
        failureLimit: 3
        timeRange: "5m"
        initialDelay: "30s"
        query: ""  # Custom Prometheus query (optional, overrides default)
      # Error rate metric (measures percentage of 5xx responses)
      errorRate:
        enabled: false
        interval: "1m"
        count: 5
        successCondition: "result <= 0.05"  # Max 5% error rate
        failureLimit: 3
        timeRange: "5m"
        initialDelay: "30s"
        query: ""  # Custom Prometheus query (optional, overrides default)
      # Custom metrics (add your own metrics here)
      custom: {}
        # Example custom metric:
        # cpu-usage:
        #   interval: "1m"
        #   count: 5
        #   successCondition: "result <= 0.80"
        #   failureLimit: 2
        #   prometheus:
        #     address: "http://monitoring-kube-prometheus-prometheus.monitoring.svc.cluster.local:9090"
        #     query: |
        #       avg(rate(container_cpu_usage_seconds_total{
        #         namespace="default",
        #         pod=~"my-app-.*"
        #       }[5m]))
    # Analysis template arguments (optional)
    args: []
      # Example:
      # - name: service-name
      #   value: my-service
